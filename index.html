<html>
	<head>
		<title>Prehistorik_js</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=640px; user-scalable=no;">
	</head>

	<body style="margin: 0px auto; text-align: center; width: 640px; background: #e5e5e5;">
		<div align="center" style="padding-top: 5px; padding-bottom: 5px; width: 640px;;">
			<div align="center">
				<canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
			</div>
		</div>
		<div style="padding-top: 0px; padding-left: 128px; padding-right: 64px; width: 448px; height: 128px;">
			<div id="joystick" style="padding-top: 128px; width: 50%; height: 100%; float: left;"></div>
			<div class="buttons" style="width: 50%; height: 100%; float: right;">
				<div id="button_jump" style="margin-top: 128px; float: left; background-color: #bbb; border-radius: 50%; width: 96px; height: 96px;"></div>
				<div id="button_action" style="margin-top: 32px; float: right; background-color: #bbb; border-radius: 50%; width: 96px; height: 96px;"></div>
			</div>
		</div>
<!--
		<div style="float: left; background-color: #aaa; margin: 8px; width: 100%;">
			<strong>prehistorik.js</strong> code is available on <a href="https://github.com/cyxx/prehistorik_js">github.com</a>.
		</div>
-->
		<script type='text/javascript'>
			var Module = {
				canvas: (function() { return document.getElementById('canvas'); })()
			};
		</script>
		<script src="pre1.js"></script>
		<script src="pre1_demo.js"></script>
		<script src="nipplejs.min.js"></script>
		<script>
			const KEYCODES = {
				'ArrowLeft': 37,
				'ArrowUp': 38,
				'ArrowRight': 39,
				'ArrowDown': 40,
				'Enter': 13,
				'Shift': 16,
				'j': 74,
			};
			function emitKeyEvent( key, evt ) {
				var ev = new Event( evt, { bubbles: true } );
				ev.key = key;
				ev.keyCode = ev.which = KEYCODES[ key ];
				Module.canvas.dispatchEvent( ev );
			}
			var joystick = nipplejs.create({
				zone: document.getElementById('joystick'),
				mode: 'static',
				dynamicPage: true,
				size: 192,
				threshold: .3,
				color: '#555',
			} );
			var direction = { left: false, right: false, up: false, down: false };
			function releaseDirectionKeys( ) {
				if ( direction.left ) {
					emitKeyEvent( 'ArrowLeft', 'keyup' );
					direction.left = false;
				}
				if ( direction.right ) {
					emitKeyEvent( 'ArrowRight', 'keyup' );
					direction.right = false;
				}
				if ( direction.up ) {
					emitKeyEvent( 'ArrowUp', 'keyup' );
					direction.up = false;
				}
				if ( direction.down ) {
					emitKeyEvent( 'ArrowDown', 'keyup' );
					direction.down = false;
				}
			}
			joystick.on( 'dir:left', function( evt, data ) {
				releaseDirectionKeys( );
				emitKeyEvent( 'ArrowLeft', 'keydown' );
				direction.left = true;
			} );
			joystick.on( 'dir:right', function( evt, data ) {
				releaseDirectionKeys( );
				emitKeyEvent( 'ArrowRight', 'keydown' );
				direction.right = true;
			} );
			joystick.on( 'dir:up', function( evt, data ) {
				releaseDirectionKeys( );
				emitKeyEvent( 'ArrowUp', 'keydown' );
				direction.up = true;
			} );
			joystick.on( 'dir:down', function( evt, data ) {
				releaseDirectionKeys( );
				emitKeyEvent( 'ArrowDown', 'keydown' );
				direction.down = true;
			} );
			joystick.on( 'end', function( evt, data ) {
				releaseDirectionKeys( );
			} );
			var button_jump = document.getElementById('button_jump');
			button_jump.onmousedown = function( ) {
				emitKeyEvent( 'j', 'keydown' );
			}
			button_jump.onmouseup = function( ) {
				emitKeyEvent( 'j', 'keyup' );
			}
			button_jump.ontouchstart = function( evt ) {
				evt.preventDefault( );
				emitKeyEvent( 'j', 'keydown' );
			}
			button_jump.ontouchend = function( evt ) {
				evt.preventDefault( );
				emitKeyEvent( 'j', 'keyup' );
			}
			var button_action = document.getElementById('button_action');
			button_action.onmousedown = function( ) {
				emitKeyEvent( 'Enter', 'keydown' );
			}
			button_action.onmouseup = function( ) {
				emitKeyEvent( 'Enter', 'keyup' );
			}
			button_action.ontouchstart = function( evt ) {
				evt.preventDefault( );
				emitKeyEvent( 'Enter', 'keydown' );
			}
			button_action.ontouchend = function( evt ) {
				evt.preventDefault( );
				emitKeyEvent( 'Enter', 'keyup' );
			}
		</script>
	</body>
</html>
